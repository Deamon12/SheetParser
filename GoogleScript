function getRichTextFromSecondColumn(sheetId) {
  Logger.log("parsing sheet!")
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  const range = sheet.getDataRange();
  const richData = range.getRichTextValues();

  let linksList = [];
  for (let i = 1; i < richData.length; i++) { // Skip header
    const richText = richData[i][1]; // 2nd column = index 1
    const url = richText.getLinkUrl(); // null if no link
    //csv += url ? `"${url}"\n` : '""\n'; // handle blank cells too
    if (url) {
      linksList.push(url); // Add the link to the list
    }
  }
  return linksList;

}

function getPlainTextFromSecondColumn(sheetId) {
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  const range = sheet.getRange(2, 2, sheet.getLastRow() - 1); // from row 2, col 2 (B), all rows except header
  const values = range.getValues(); // gets values as 2D array

  let plainTextList = [];

  for (let i = 0; i < values.length; i++) {
    plainTextList.push(values[i][0]); // Each row is an array with one value
  }

  Logger.log(plainTextList);
  return plainTextList;
}

function iterateLinks(listOfLinks) {
  let index = 2;
  listOfLinks.forEach(function(link) {
    Logger.log('Link: ' + link);
    const docId = extractDocIdFromUrl(link); // Extract the document ID from the URL
    Logger.log('Processing Google Doc: ' + docId);
    if(docId != null) {
      let rowData = parseDocSections(docId);//parseDocSections(docId);
      Logger.log(rowData)
      writeSectionsToSheet(rowData, index)
    }
  
    index++;
  });
}

function writeSectionsToSheet(sections, rowIndex) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sections.forEach(function(item, index) {
    sheet.getRange(rowIndex, index + 1).setValue(item); // Column index starts from 1, so add 1 to `index`
  });
}


function parseDocSections(docId) {

  const doc = DocumentApp.openById(docId); // Open the Google Doc using the DocumentApp API
  const body = doc.getBody();     // Get the body of the document
  const numElements = body.getNumChildren();
  Logger.log("numElements: " + numElements)
  const paragraphs = body.getParagraphs();      // Iterate through all elements in the body

  let whichH2 = 0;
  let whichH3 = 0;

  let currentNormal = '';
  let textSections = [];

  textSections.push("todo route"); // empty first spot...
  paragraphs.forEach(function(paragraph) {
    const text = paragraph.getText(); // Get the text content of the paragraph

    //Logger.log("Type: " + paragraph.getHeading())
    //textSections.push(text)

    // H1
    // N

    // H2 - x6
    // Normal

    // H2

    // H3 - x7
    // N



    // Example: Check if the paragraph is a heading (e.g., Heading 1)
    if (paragraph.getHeading() === DocumentApp.ParagraphHeading.HEADING1) {
      if(currentNormal != '') {
        textSections.push(currentNormal);
        currentNormal = '';
      }
      Logger.log('Heading 1: ' + text);
      textSections.push(text);
    }

    if (paragraph.getHeading() === DocumentApp.ParagraphHeading.HEADING2) {
      if(currentNormal != '') {
        textSections.push(currentNormal);
        currentNormal = '';
      }
      //Logger.log('Heading 2: ' + text);
      textSections.push(text);
    }

    if (paragraph.getHeading() === DocumentApp.ParagraphHeading.HEADING3) {
      if(currentNormal != '') {
        textSections.push(currentNormal);
        currentNormal = '';
      }
      //Logger.log('Heading 2: ' + text);
      textSections.push(text);
    }

    // Example: Check if the paragraph is a regular paragraph
    if (paragraph.getHeading() === DocumentApp.ParagraphHeading.NORMAL) {
      //Logger.log('Normal Paragraph: ' + text);
      currentNormal += text;
    }

    // You can add more conditions to check for other types of sections (Headings 2, 3, Lists, etc.)
  });
  Logger.log("textSections: " + textSections)
  return textSections;
}

function extractDocIdFromUrl(url) {
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  return match ? match[1] : null;
}

function importDocToSheet(docId) {
  Logger.log("parsing doc!")
  //const docId = '1imEmCKCVg0hnNTbONt7YNmxmXe4yTFf09xxgOmgI3F4'; // From the URL of your Google Doc
  const body = DocumentApp.openById(docId).getBody().getText();
  const lines = body.split('\n');

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.clear(); // optional

  lines.forEach((line, i) => {
    const cells = line.split(','); // or '\t' for tab-separated
    sheet.getRange(i + 1, 1, 1, cells.length).setValues([cells]);
  });
}

function clearSheetExceptTopRow() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const lastRow = sheet.getLastRow();
  const lastColumn = sheet.getLastColumn();

  // Clear all rows except the first one
  if (lastRow > 1) {
    sheet.getRange(2, 1, lastRow - 1, lastColumn).clearContent();
  }
}

function tagCellsUsingSwitch() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const range = sheet.getDataRange();
  const values = range.getValues(); // 2D array of all data

  // Start from row 1 if row 0 is the header
  for (let row = 1; row < values.length; row++) {
    for (let col = 0; col < values[0].length; col++) {
      let cellValue = values[row][col];
      if (typeof cellValue !== 'string' || !cellValue.trim()) continue;

      let title;
      let result;
      let lines;

      switch (col) {
        case 4: // article_section_1
        case 6: // article_section_2
        case 8: // article_section_3
        case 10: // article_section_4
        case 12: // article_section_5
        case 14: // article_section_6
          title = values[row][col-1];
          result = `<h2>${title}</h2><ul>`;
          lines = cellValue.split('.');
          for (let i = 0; i < lines.length; i++) {
            if(lines[i].length == 0) {
              continue;
            }
            result += `<li>${lines[i]}</li>`;
          }
          result += `</ul>`;
          values[row][col] = result;
          break;

/*
        case 2: // Column C (e.g., 'intro_copy')
          if (!cellValue.includes('<p>')) {
            values[row][col] = `<p>${cellValue}</p>`;
          }
          break;

        case 16: // Column Q (e.g., 'accordion_headline_1')
          if (!cellValue.includes('<h3>')) {
            values[row][col] = `<h3>${cellValue}</h3>`;
          }
          break;

        case 17: // Column R (e.g., 'accordion_info_1')
          if (!cellValue.includes('<div>')) {
            values[row][col] = `<div>${cellValue}</div>`;
          }
          break;
          */
        // Add more cases as needed
      }
    }
  }

  // Write back updated values
  range.setValues(values);
}

function main() {
  let sheetId = '130zr5deVEjZMkBXubnhLhyADqUaDIwWUuegEvJQw4ns'; // with hyper
  sheetId = "1fRtT04cuk6dYsTAiIe5_7mBGn9TGTDnn-rC-R57Rlj8"  // no hyper
  const links = getPlainTextFromSecondColumn(sheetId); //parseSheetToCSV();
  Logger.log(links);
  clearSheetExceptTopRow();
  iterateLinks(links);
  tagCellsUsingSwitch();
}
